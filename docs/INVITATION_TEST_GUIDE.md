# 招待リンク動作確認ガイド

## 📋 動作確認手順

### 1. サーバーの起動確認

現在サーバーが起動している場合は、変更を反映するために再起動してください。

#### サーバーを停止する場合
ターミナルで `Ctrl + C` を押してサーバーを停止します。

#### サーバーを起動する場合
```powershell
python -m api.main
```

サーバーが正常に起動すると、以下のメッセージが表示されます：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

---

### 2. テスト用招待の作成

#### 方法A: Pythonスクリプトを使用（推奨）

新しいターミナルを開いて、以下のコマンドを実行します：

```powershell
python scripts/test_invitation.py test@example.com "テスト店舗"
```

**出力例：**
```
✅ 招待が作成されました！
📧 メールアドレス: test@example.com
🔗 招待URL: http://localhost:8000/invite/xxxxxxxxxxxxx
📝 トークン: xxxxxxxxxxxxx
⏰ 有効期限: 2025-01-05T15:00:00+00:00

🌐 ブラウザで以下のURLにアクセスしてください:
   http://localhost:8000/invite/xxxxxxxxxxxxx
```

#### 方法B: curlコマンドを使用

```powershell
curl -X POST "http://localhost:8000/api/v1/invitations/" `
  -H "Content-Type: application/json" `
  -d '{\"email\": \"test@example.com\", \"shop_name\": \"テスト店舗\", \"expires_in_days\": 7}'
```

#### 方法C: ブラウザの開発者ツールを使用

1. ブラウザで `http://localhost:8000` を開く
2. F12キーで開発者ツールを開く
3. Consoleタブで以下を実行：

```javascript
fetch('http://localhost:8000/api/v1/invitations/', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    email: 'test@example.com',
    shop_name: 'テスト店舗',
    expires_in_days: 7
  })
})
.then(r => r.json())
.then(data => {
  console.log('招待URL:', data.invitation_url);
  window.open(data.invitation_url);
});
```

---

### 3. 招待リンクにアクセス

作成された招待URLをブラウザで開きます。

**例：** `http://localhost:8000/invite/xxxxxxxxxxxxx`

---

### 4. 動作確認ポイント

#### ✅ 確認項目

1. **ページの表示**
   - [ ] 招待ページが正常に表示される
   - [ ] 「店舗アカウント設定」のタイトルが表示される
   - [ ] 招待メールアドレスが表示される

2. **フォームの表示**
   - [ ] 店舗名の入力欄が表示される
   - [ ] 管理者名の入力欄が表示される
   - [ ] 管理者メールアドレスの入力欄が表示される
   - [ ] パスワードの入力欄が表示される
   - [ ] パスワード確認の入力欄が表示される

3. **フォーム送信**
   - [ ] 必須項目を入力して送信できる
   - [ ] パスワードが一致しない場合、エラーメッセージが表示される
   - [ ] 送信後、成功メッセージが表示される
   - [ ] 「管理画面へ」のリンクが表示される

4. **アカウント作成**
   - [ ] アカウント作成後、管理画面にアクセスできる
   - [ ] 作成したアカウントでログインできる

---

### 5. トラブルシューティング

#### 問題: ページが404エラーになる

**原因：** サーバーが再起動されていない、またはルートが正しく登録されていない

**解決方法：**
1. サーバーを再起動する
2. `api/main.py` に `/invite/{token}` ルートが追加されているか確認

#### 問題: 招待検証エラーが表示される

**原因：** トークンが無効、または有効期限切れ

**解決方法：**
1. 新しい招待を作成する
2. トークンが正しくURLに含まれているか確認

#### 問題: API呼び出しエラー

**原因：** CORS設定やAPIエンドポイントの問題

**解決方法：**
1. ブラウザの開発者ツール（F12）でConsoleタブを確認
2. NetworkタブでAPIリクエストのステータスを確認
3. サーバーのログを確認

#### 問題: アカウント作成に失敗する

**原因：** データベース接続エラーやテーブルが存在しない

**解決方法：**
1. データベース接続設定を確認
2. `shops` テーブルと `invitations` テーブルが存在するか確認
3. サーバーのログを確認

---

### 6. 確認用コマンド

#### 招待の検証（API直接呼び出し）

```powershell
# トークンを置き換えて実行
curl "http://localhost:8000/api/v1/invitations/verify/YOUR_TOKEN_HERE"
```

#### 招待一覧の取得

```powershell
curl "http://localhost:8000/api/v1/invitations/"
```

---

### 7. 次のステップ

招待リンクが正常に動作することを確認したら：

1. **管理画面でのログイン確認**
   - 作成したアカウントでログインできるか確認
   - 店舗情報が正しく表示されるか確認

2. **本番環境でのテスト**
   - 実際のメールアドレスで招待を作成
   - メール送信機能が動作するか確認

3. **セキュリティ確認**
   - 無効なトークンでアクセスできないか確認
   - 有効期限切れのトークンでアクセスできないか確認

---

## 📝 メモ

- 招待トークンは32文字のランダム文字列です
- デフォルトの有効期限は7日間です
- 同じメールアドレスで複数の有効な招待は作成できません
- 招待を使用すると、自動的に `used` フラグが `true` になります


